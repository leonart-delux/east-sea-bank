CREATE DATABASE CTyQTECH

USE CTyQTECH

CREATE TABLE KHACHHANG 
(
	MAKH VARCHAR(10) NOT NULL PRIMARY KEY,
	TENKH NVARCHAR(200),
	DIACHI NVARCHAR(100),
	SDT VARCHAR(10),
	NGAYSINH DATETIME,
	NGAYDK DATETIME
)
CREATE TABLE SANPHAM
(
	MASP VARCHAR(10) NOT NULL PRIMARY KEY,
	TENSP NVARCHAR(100),
	GIA INT,
	TONKHO INT,
	MOTA NVARCHAR(100)
)
CREATE TABLE NHANVIEN
(
	MANV VARCHAR(10) NOT NULL PRIMARY KEY,
	TENNV NVARCHAR(200),
	CHUCVU NVARCHAR(100),
	SDT INT,
	EMAIL VARCHAR(100),
	NGAYTV DATETIME
)
CREATE TABLE DONHANG
(
	MAHD VARCHAR(10) NOT NULL PRIMARY KEY,
	NGAYDAT DATETIME,
	MAKH VARCHAR(10)
	FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),
	MANV VARCHAR(10)
	FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV),
	TONGTIEN INT
)
CREATE TABLE CTHOADON
(
	MAHD VARCHAR(10) NOT NULL,
	FOREIGN KEY (MAHD) REFERENCES DONHANG(MAHD),
	MASP VARCHAR(10) NOT NULL,
	FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP),
	SOLUONG INT,
	GHICHU NVARCHAR(500) NULL
)

SET DATEFORMAT DMY

INSERT INTO KHACHHANG(MAKH,TENKH,DIACHI,SDT,NGAYSINH,NGAYDK)
VALUES('KH01',N'NGUYỄN VĂN TIẾN',N'Bình Thạnh,TP.HCM','0989006650','01/12/2000','01/01/2022'),
	 ('KH02',N'LÊ TUẤN ANH',N'Quận 3,TP.HCM','0989562603','26/10/2001','15/03/2022'),
	 ('KH03',N'TRẦN ANH THƯ',N'Quận 9,TP.HCM','0926006626','03/09/1990','10/04/2022'),
	 ('KH04',N'LÊ HAI',N'Thủ Đức,TP.HCM','0982606054','19/12/1998','05/05/2022'),
	 ('KH05',N'VŨ HIỀN TUẤN',N'Gò Vấp,TP.HCM','0926006660','20/10/2001','06/06/2022')

INSERT INTO SANPHAM(MASP, TENSP, GIA, TONKHO, MOTA)
VALUES('SP101',N'Laptop DELL', 15000000 ,20,N'Laptop cho văn phòng'),
	 ('SP102',N'Iphone 13', 25000000 ,15,N'Điện thoại cao cấp'),
	 ('SP103',N'Airpds Pro', 6000000 ,50,N'Tai nghe không dây'),
	 ('SP104',N'Samsung S21', 20000000 ,10,N'Điện thoại Android'),
	 ('SP105',N'Máy lọc nước', 5500000 ,30,N'Máy lọc nước gia đình')

INSERT INTO NHANVIEN(MANV,TENNV,CHUCVU,SDT,EMAIL,NGAYTV)
VALUES('NV01',N'Trần Tính',N'Nhân viên bán hàng',0987001122,'tranvana@qtech.com','01/01/2020'),
	  ('NV02',N'Nguyễn An',N'Nhân viên kho',0987551223,'nguyenthib@qtech.com','15/02/2021'),
	  ('NV03',N'Lê Tuấn An',N'Quản lí bán hàng',0987231124,'lehoangc@qtech.com','20/03/2020')

SET DATEFORMAT MDY
INSERT INTO DONHANG(MAHD, NGAYDAT, MAKH, MANV, TONGTIEN)
VALUES('HD001','02/02/2022','KH01','NV01',450000000),
	 ('HD002','03/18/2022','KH02','NV02',30000000),
	 ('HD003','05/15/2022','KH01','NV01',30000000),
	 ('HD004','05/15/2022','KH03','NV03',35000000),
	 ('HD005','06/01/2022','KH04','NV02',20000000)

INSERT INTO CTHOADON(MAHD, MASP, SOLUONG, GHICHU)
VALUES('HD001','SP101',10,N'Hàng giá trị cao'),
	 ('HD001','SP102',5,NULL),
	 ('HD002','SP105',2,N'Hàng giá trị cao'),
	 ('HD003','SP103',10,NULL),
	 ('HD004','SP104',5,N'Hàng giá trị cao'),
	 ('HD005','SP101',2,NULL)
--2b: không thành công.INSERT IN TO CTHOADON('HD005','SP102',150,N'Hàng giá trị cao')
--Câu 3: Cập nhật in4 sp GÍA lên 10% đối với sản phẩm có giá trị nhỏ hơn 10.500.000 và số lượng tồn dưới 100
SELECT *
FROM SANPHAM
GO
UPDATE SANPHAM
SET GIA=GIA*1.1
WHERE GIA<10500000 AND TONKHO<100
SELECT *
FROM SANPHAM
--Câu 4:
----a.Liệt kê các đơn hàng có tổng tiền >20tr và đc xử lý bởi nhân viên có mã NV01
SELECT *
FROM DONHANG
WHERE TONGTIEN>20000000 AND MANV='NV01'
----b.Tìm các khách hàng có địa chỉ ở 'TP.HCM'. và sđt bắt đầu '098'
SELECT *
FROM KHACHHANG
WHERE DIACHI LIKE '%TP.HCM' AND SDT LIKE '098%'
--Câu 5: Liệt kê khách hàng đã đặt ít nhất 1 đơn hàng có tổng tiền>50tr
SELECT K.MAKH,K.TENKH,M.SLDONHANG,M.TONGTIEN
FROM KHACHHANG K JOIN (SELECT COUNT(D.MAHD) AS SLDONHANG, D.MAKH,D.TONGTIEN
					FROM DONHANG D JOIN KHACHHANG K ON D.MAKH=K.MAKH
					GROUP BY D.MAKH,D.TONGTIEN
					HAVING COUNT(D.MAHD)>=1)M ON K.MAKH=M.MAKH
WHERE M.TONGTIEN>50000000
GROUP BY K.MAKH,K.TENKH,M.SLDONHANG,M.TONGTIEN

--Câu 6: Liệt kê mã KH và tổng tiền của đơn hàng mà > tổng tiền trung bình all đơn hàng
SELECT K.MAKH,(SELECT AVG(D.TONGTIEN)
						FROM DONHANG D) AS TONGTIENTB
FROM KHACHHANG K JOIN DONHANG D ON K.MAKH=D.MAKH
WHERE D.TONGTIEN> ALL(SELECT AVG(D.TONGTIEN)
						FROM DONHANG D)

--caau7: liệt kê các nhân viên có tổng số đơn hàng đã xử lý > tổng số đơn hàng trung bình của all NV
SELECT N.TENNV,D.MANV
FROM NHANVIEN N JOIN DONHANG D ON N.MANV = D.MANV
GROUP BY N.TENNV,D.MANV
HAVING COUNT(D.MAHD) > (SELECT AVG(SL)
						FROM (SELECT COUNT(MAHD) AS SL ,MANV
								FROM DONHANG 
								GROUP BY MANV) AS T)


								
								


